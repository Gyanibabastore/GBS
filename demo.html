<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Signup Page</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Toastify CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<!-- Toastify JS -->
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <style>* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(to right, #4facfe, #00f2fe);
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.signup-container {
  background: #fff;
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 0 15px rgba(0,0,0,0.1);
  max-width: 450px;
  width: 90%;
}

.signup-form h2 {
  text-align: center;
  margin-bottom: 20px;
  color: #333;
}

.signup-form input,
.signup-form select {
  width: 100%;
  padding: 10px 15px;
  margin-bottom: 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
}

.signup-form .role-switch {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-bottom: 15px;
}

.signup-form button {
  width: 100%;
  background: #4facfe;
  border: none;
  padding: 12px;
  color: white;
  font-size: 18px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s ease;
}

.signup-form button:hover {
  background: #00c6fb;
}

.hidden {
  display: none;
}

#password-strength {
  margin-bottom: 10px;
  font-size: 14px;
  color: #333;
}

#password-strength ul {
  list-style: none;
  padding-left: 0;
}

#password-strength li {
  margin-bottom: 5px;
  color: gray;
}

#password-strength li.valid {
  color: green;
}

@media (max-width: 480px) {
  .signup-container {
    padding: 20px;
  }

  .signup-form h2 {
    font-size: 24px;
  }
}
</style>
</head>
<body>
  <div class="signup-container">
    <form class="signup-form" onsubmit="return validateForm()">
      <h2>Sign Up</h2>

      <div class="role-switch">
        <label>
          <input type="radio" name="role" value="buyer" checked onchange="toggleRole()"> Buyer
        </label>
        <label>
          <input type="radio" name="role" value="seller" onchange="toggleRole()"> Seller
        </label>
      </div>

      <input type="text" id="name" placeholder="Full Name" required />
      <input type="tel" id="mobile" placeholder="Mobile Number" pattern="[0-9]{10}" required />
      <input type="email" id="email" placeholder="Email Address" required />

      <select id="gender" required>
        <option value="" disabled selected>Select Gender</option>
        <option>Male</option>
        <option>Female</option>
        <option>Other</option>
      </select>

      <input type="text" id="upi" placeholder="UPI ID" required />
      <input type="text" id="address" placeholder="Address" required />
      <input type="text" id="pincode" placeholder="Pincode" pattern="[0-9]{6}" required />

      <input type="text" id="shopName" placeholder="Shop Name" class="hidden" />

      <input type="password" id="password" placeholder="Password" required onkeyup="checkPasswordStrength()"/>
      <div id="password-strength">
        <p>Password must have:</p>
        <ul>
          <li id="length">✔ At least 8 characters</li>
          <li id="lowercase">✔ One lowercase letter</li>
          <li id="uppercase">✔ One uppercase letter</li>
          <li id="number">✔ One number</li>
          <li id="special">✔ One special character</li>
        </ul>
      </div>

    <div id="otpSection" class="hidden">
  <input type="text" id="otp" placeholder="Enter OTP" />
  <button type="button" onclick="handleVerifyOtp()">Verify OTP</button>
  <p id="countdownText">Resend OTP in <span id="countdown">30</span> seconds</p>
  <button type="button" id="resendBtn" onclick="handleResendOtp()" disabled>Resend OTP</button>
</div>


    </form>
  </div>
  <script>let countdownInterval;

function toggleRole() {
  const role = document.querySelector('input[name="role"]:checked').value;
  document.getElementById("shopName").classList.toggle("hidden", role === "buyer");
}

function checkPasswordStrength() {
  const password = document.getElementById("password").value;

  const checks = {
    length: password.length >= 8,
    lowercase: /[a-z]/.test(password),
    uppercase: /[A-Z]/.test(password),
    number: /[0-9]/.test(password),
    special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
  };

  for (const [key, value] of Object.entries(checks)) {
    document.getElementById(key).classList.toggle("valid", value);
  }
}

function validatePassword(password) {
  return password.length >= 8 &&
    /[a-z]/.test(password) &&
    /[A-Z]/.test(password) &&
    /[0-9]/.test(password) &&
    /[!@#$%^&*(),.?":{}|<>]/.test(password);
}

function showToast(message, color = "green") {
  Toastify({
    text: message,
    duration: 3000,
    gravity: "top",
    position: "right",
    backgroundColor: color,
  }).showToast();
}

async function handleRegister() {
  const role = document.querySelector('input[name="role"]:checked').value;
  const mobile = document.getElementById("mobile").value;
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  if (!validatePassword(password)) {
    showToast("Password must meet the criteria", "red");
    return;
  }

  if (!/^[0-9]{10}$/.test(mobile)) {
    showToast("Enter a valid 10-digit mobile", "red");
    return;
  }

  if (!/^\S+@\S+\.\S+$/.test(email)) {
    showToast("Enter a valid email address", "red");
    return;
  }

  await sendOtpRequest(mobile, email, role);
}

async function sendOtpRequest(mobile, email, role) {
  try {
    const res = await fetch("auth/send-otp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mobile, email, role })
    });

    const data = await res.json();

    if (data.success) {
      showToast("OTP sent to your email & mobile.");
      document.getElementById("otpSection").classList.remove("hidden");
      startCountdown();
    } else {
      showToast("Failed to send OTP.", "red");
    }
  } catch (error) {
    console.error(error);
    showToast("Network error while sending OTP", "red");
  }
}

function startCountdown() {
  const resendBtn = document.getElementById("resendBtn");
  const countdownText = document.getElementById("countdown");
  let time = 30;
  resendBtn.disabled = true;
  countdownText.innerText = time;

  clearInterval(countdownInterval); // avoid duplicates

  countdownInterval = setInterval(() => {
    time--;
    countdownText.innerText = time;

    if (time <= 0) {
      clearInterval(countdownInterval);
      resendBtn.disabled = false;
    }
  }, 1000);
}

async function handleResendOtp() {
  const role = document.querySelector('input[name="role"]:checked').value;
  const mobile = document.getElementById("mobile").value;
  const email = document.getElementById("email").value;

  await sendOtpRequest(mobile, email, role);
}

async function handleVerifyOtp() {
  const role = document.querySelector('input[name="role"]:checked').value;
  const mobile = document.getElementById("mobile").value;
  const email = document.getElementById("email").value;
  const otp = document.getElementById("otp").value;

  if (otp.length < 4) {
    showToast("Enter a valid OTP", "red");
    return;
  }

  try {
    const res = await fetch("auth/verify-otp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mobile, email, otp, role })
    });

    const data = await res.json();

    if (data.success) {
      showToast("OTP Verified!");
      window.location.href = `/${role}/dashboard`;
    } else {
      showToast("OTP is incorrect.", "red");
    }
  } catch (error) {
    console.error(error);
    showToast("Network error verifying OTP", "red");
  }
}
</script>
  <script src="script.js"></script>
</body>
</html>
